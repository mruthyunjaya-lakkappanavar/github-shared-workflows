name: Reusable CI

on:
  workflow_call:
    inputs:
      language:
        description: "Programming language: python, node, or go"
        required: true
        type: string
      language_version:
        description: "Language version (e.g., 3.11, 20, 1.22)"
        required: true
        type: string
      working_directory:
        description: "Path to source code"
        required: false
        type: string
        default: "."
      enable_lint:
        description: "Run linting job"
        required: false
        type: boolean
        default: true
      enable_security_scan:
        description: "Run security scanning job (SAST + dependency audit + Trivy)"
        required: false
        type: boolean
        default: true
      enable_test:
        description: "Run test suite job"
        required: false
        type: boolean
        default: true
      coverage_threshold:
        description: "Minimum code coverage percentage (0 to disable)"
        required: false
        type: number
        default: 80
    secrets:
      SLACK_WEBHOOK_URL:
        required: false

permissions:
  contents: read
  pull-requests: write
  issues: write

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  JOB 1 ‚Äî LINT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
jobs:
  lint:
    name: Lint
    if: ${{ inputs.enable_lint }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      status: ${{ steps.result.outputs.status }}
      error_count: ${{ steps.result.outputs.error_count }}
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup toolchain
        uses: mruthyunjaya-lakkappanavar/github-shared-workflows/actions/setup-toolchain@main
        with:
          language: ${{ inputs.language }}
          language_version: ${{ inputs.language_version }}

      - name: Install Python dependencies
        if: inputs.language == 'python'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Install Node dependencies
        if: inputs.language == 'node'
        run: npm ci

      - name: Install Go dependencies
        if: inputs.language == 'go'
        run: go mod download

      - name: Run linter
        id: lint
        shell: bash
        run: |
          set +e
          ERROR_COUNT=0
          OUTPUT=""
          EXIT_CODE=0

          if [ "${{ inputs.language }}" = "python" ]; then
            OUTPUT=$(flake8 . --count --max-complexity=10 --max-line-length=127 --statistics 2>&1)
            EXIT_CODE=$?
            ERROR_COUNT=$(echo "$OUTPUT" | tail -1 | grep -oE '^[0-9]+' || true)
            ERROR_COUNT=${ERROR_COUNT:-0}

          elif [ "${{ inputs.language }}" = "node" ]; then
            OUTPUT=$(npx eslint . --max-warnings=0 2>&1)
            EXIT_CODE=$?
            if [ "$EXIT_CODE" -ne 0 ]; then
              ERROR_COUNT=$(echo "$OUTPUT" | grep -oE '[0-9]+ error' | head -1 | grep -oE '[0-9]+' || true)
              ERROR_COUNT=${ERROR_COUNT:-1}
            fi

          elif [ "${{ inputs.language }}" = "go" ]; then
            curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b "$(go env GOPATH)/bin" v1.62.2 2>/dev/null
            export PATH="$(go env GOPATH)/bin:$PATH"
            OUTPUT=$(golangci-lint run --out-format=line-number 2>&1)
            EXIT_CODE=$?
            if [ "$EXIT_CODE" -ne 0 ]; then
              ERROR_COUNT=$(echo "$OUTPUT" | wc -l | tr -d ' ')
            fi
          fi

          echo "$OUTPUT"
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          echo "error_count=${ERROR_COUNT:-0}" >> "$GITHUB_OUTPUT"
          {
            echo "output<<__LINT_DELIM__"
            echo "$OUTPUT" | head -100
            echo "__LINT_DELIM__"
          } >> "$GITHUB_OUTPUT"

      - name: Set result
        id: result
        if: always()
        run: |
          if [ "${{ steps.lint.outputs.exit_code }}" = "0" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
          fi
          echo "error_count=${{ steps.lint.outputs.error_count }}" >> "$GITHUB_OUTPUT"
          echo "::notice title=ci_lint::errors=${{ steps.lint.outputs.error_count }}"

      - name: Fail if lint errors
        if: steps.lint.outputs.exit_code != '0'
        run: exit 1

      - name: Notify Slack on lint failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        uses: mruthyunjaya-lakkappanavar/github-shared-workflows/actions/slack-notify@main
        with:
          status: failure
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          repo_name: ${{ github.repository }}
          run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          message: "Lint failed for ${{ inputs.language }}"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  JOB 2 ‚Äî TEST
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  test:
    name: Test
    if: ${{ inputs.enable_test }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.result.outputs.status }}
      total: ${{ steps.result.outputs.total }}
      passed: ${{ steps.result.outputs.passed }}
      failed: ${{ steps.result.outputs.failed }}
      coverage: ${{ steps.result.outputs.coverage }}
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup toolchain
        uses: mruthyunjaya-lakkappanavar/github-shared-workflows/actions/setup-toolchain@main
        with:
          language: ${{ inputs.language }}
          language_version: ${{ inputs.language_version }}

      - name: Install Python dependencies
        if: inputs.language == 'python'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install pytest-cov 2>/dev/null || true

      - name: Install Node dependencies
        if: inputs.language == 'node'
        run: npm ci

      - name: Install Go dependencies
        if: inputs.language == 'go'
        run: go mod download

      - name: Run tests
        id: tests
        shell: bash
        run: |
          set +e
          TOTAL=0; PASSED=0; FAILED=0; EXIT_CODE=0; COVERAGE="N/A"

          if [ "${{ inputs.language }}" = "python" ]; then
            pytest --junitxml=test-results.xml --tb=short -v --cov=src --cov-report=term-missing 2>&1 | tee test-output.txt
            EXIT_CODE=${PIPESTATUS[0]}
            if [ -f test-results.xml ]; then
              TOTAL=$(python3 -c "
          import xml.etree.ElementTree as ET
          r = ET.parse('test-results.xml').getroot()
          print(r.attrib.get('tests', '0'))
          " 2>/dev/null || true)
              TOTAL=${TOTAL:-0}
              FAIL_COUNT=$(python3 -c "
          import xml.etree.ElementTree as ET
          r = ET.parse('test-results.xml').getroot()
          f = int(r.attrib.get('failures', '0'))
          e = int(r.attrib.get('errors', '0'))
          print(f + e)
          " 2>/dev/null || true)
              FAIL_COUNT=${FAIL_COUNT:-0}
              FAILED=${FAIL_COUNT:-0}
              PASSED=$((TOTAL - FAILED))
            fi
            # Extract coverage percentage
            COV_LINE=$(grep "^TOTAL" test-output.txt | tail -1)
            if [ -n "$COV_LINE" ]; then
              COVERAGE=$(echo "$COV_LINE" | grep -oE '[0-9]+%' | tail -1 || true)
              COVERAGE=${COVERAGE:-N/A}
            fi

          elif [ "${{ inputs.language }}" = "node" ]; then
            npx jest --ci --verbose --coverage 2>&1 | tee test-output.txt
            EXIT_CODE=${PIPESTATUS[0]}
            SUMMARY=$(grep "Tests:" test-output.txt | tail -1)
            TOTAL=$(echo "$SUMMARY" | grep -oE '[0-9]+ total' | grep -oE '[0-9]+' || true)
            TOTAL=${TOTAL:-0}
            PASSED=$(echo "$SUMMARY" | grep -oE '[0-9]+ passed' | grep -oE '[0-9]+' || true)
            PASSED=${PASSED:-0}
            FAILED=$(echo "$SUMMARY" | grep -oE '[0-9]+ failed' | grep -oE '[0-9]+' || true)
            FAILED=${FAILED:-0}
            # Extract coverage from jest output (All files line)
            COV_LINE=$(grep "All files" test-output.txt | head -1)
            if [ -n "$COV_LINE" ]; then
              COVERAGE=$(echo "$COV_LINE" | awk -F'|' '{gsub(/ /,"",$2); print $2}' || true)
              COVERAGE=${COVERAGE:-N/A}
              if [ "$COVERAGE" != "N/A" ]; then COVERAGE="${COVERAGE}%"; fi
            fi

          elif [ "${{ inputs.language }}" = "go" ]; then
            go test -v -race -coverprofile=coverage.out ./... 2>&1 | tee test-output.txt
            EXIT_CODE=${PIPESTATUS[0]}
            PASSED=$(grep -c "^--- PASS" test-output.txt || true)
            PASSED=${PASSED:-0}
            FAILED=$(grep -c "^--- FAIL" test-output.txt || true)
            FAILED=${FAILED:-0}
            TOTAL=$((PASSED + FAILED))
            # Extract coverage from go test output
            if [ -f coverage.out ]; then
              COVERAGE=$(go tool cover -func=coverage.out 2>/dev/null | grep "^total:" | awk '{print $NF}' || true)
              COVERAGE=${COVERAGE:-N/A}
            fi
          fi

          TOTAL=${TOTAL:-0}; PASSED=${PASSED:-0}; FAILED=${FAILED:-0}
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
          echo "passed=$PASSED" >> "$GITHUB_OUTPUT"
          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"
          echo "coverage=$COVERAGE" >> "$GITHUB_OUTPUT"

      - name: Set result
        id: result
        if: always()
        run: |
          if [ "${{ steps.tests.outputs.exit_code }}" = "0" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
          fi
          echo "total=${{ steps.tests.outputs.total }}" >> "$GITHUB_OUTPUT"
          echo "passed=${{ steps.tests.outputs.passed }}" >> "$GITHUB_OUTPUT"
          echo "failed=${{ steps.tests.outputs.failed }}" >> "$GITHUB_OUTPUT"
          echo "coverage=${{ steps.tests.outputs.coverage }}" >> "$GITHUB_OUTPUT"
          echo "::notice title=ci_test::total=${{ steps.tests.outputs.total }}|passed=${{ steps.tests.outputs.passed }}|failed=${{ steps.tests.outputs.failed }}|coverage=${{ steps.tests.outputs.coverage }}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.language }}
          path: |
            **/test-results.xml
            **/test-output.txt
            **/coverage.out
          retention-days: 30

      - name: Fail if tests failed
        if: steps.tests.outputs.exit_code != '0'
        run: exit 1

      - name: Notify Slack on test failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        uses: mruthyunjaya-lakkappanavar/github-shared-workflows/actions/slack-notify@main
        with:
          status: failure
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          repo_name: ${{ github.repository }}
          run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          message: "Unit tests failed for ${{ inputs.language }}"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  JOB 3 ‚Äî SECURITY SCAN (SAST + Dependency Audit + Trivy)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  security:
    name: Security Scan
    if: ${{ inputs.enable_security_scan }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.result.outputs.status }}
      sast_findings: ${{ steps.result.outputs.sast_findings }}
      dep_findings: ${{ steps.result.outputs.dep_findings }}
      critical: ${{ steps.result.outputs.critical }}
      high: ${{ steps.result.outputs.high }}
      medium: ${{ steps.result.outputs.medium }}
      low: ${{ steps.result.outputs.low }}
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup toolchain
        uses: mruthyunjaya-lakkappanavar/github-shared-workflows/actions/setup-toolchain@main
        with:
          language: ${{ inputs.language }}
          language_version: ${{ inputs.language_version }}

      - name: Install Python dependencies
        if: inputs.language == 'python'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install bandit pip-audit

      - name: Install Node dependencies
        if: inputs.language == 'node'
        run: |
          npm ci
          npm install --no-save eslint-plugin-security 2>/dev/null || true

      - name: Install Go dependencies
        if: inputs.language == 'go'
        run: |
          go mod download
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: SAST Scan
        id: sast
        shell: bash
        run: |
          set +e
          FINDINGS=0

          if [ "${{ inputs.language }}" = "python" ]; then
            echo "=== Bandit SAST Scan ==="
            bandit -r src/ -f json -o bandit-report.json 2>&1
            bandit -r src/ -f screen 2>&1
            if [ -f bandit-report.json ]; then
              FINDINGS=$(python3 -c "
          import json
          with open('bandit-report.json') as f:
              d = json.load(f)
          results = d.get('results') or []
          print(len(results))
          " 2>/dev/null || true)
              FINDINGS=${FINDINGS:-0}
            fi

          elif [ "${{ inputs.language }}" = "node" ]; then
            echo "=== ESLint Security Scan ==="
            OUTPUT=$(npx eslint . --rule '{"no-eval":"error"}' --max-warnings=0 2>&1)
            EC=$?
            echo "$OUTPUT"
            if [ "$EC" -ne 0 ]; then
              FINDINGS=$(echo "$OUTPUT" | grep -cE "error|warning" || true)
              FINDINGS=${FINDINGS:-1}
            fi

          elif [ "${{ inputs.language }}" = "go" ]; then
            echo "=== gosec SAST Scan ==="
            gosec -fmt json -out gosec-report.json ./... 2>&1
            gosec -fmt text ./... 2>&1
            if [ -f gosec-report.json ]; then
              FINDINGS=$(python3 -c "
          import json
          with open('gosec-report.json') as f:
              d = json.load(f)
          issues = d.get('Issues') or []
          print(len(issues))
          " 2>/dev/null || true)
              FINDINGS=${FINDINGS:-0}
            fi
          fi

          echo "findings=${FINDINGS:-0}" >> "$GITHUB_OUTPUT"
          echo "::notice::SAST found $FINDINGS finding(s)"

      - name: Dependency Audit
        id: deps
        shell: bash
        run: |
          set +e
          DEP_FINDINGS=0

          if [ "${{ inputs.language }}" = "python" ]; then
            echo "=== pip-audit ==="
            pip-audit --desc --format columns 2>&1 | tee pip-audit-output.txt
            PIP_EXIT=${PIPESTATUS[0]}
            if [ "$PIP_EXIT" -ne 0 ]; then
              DEP_FINDINGS=$(grep -cE "^[a-zA-Z]" pip-audit-output.txt || true)
              DEP_FINDINGS=${DEP_FINDINGS:-1}
            fi

          elif [ "${{ inputs.language }}" = "node" ]; then
            echo "=== npm audit ==="
            npm audit 2>&1 | tee npm-audit-output.txt
            NPM_EXIT=${PIPESTATUS[0]}
            if [ "$NPM_EXIT" -ne 0 ]; then
              DEP_FINDINGS=$(grep -cE "Severity:" npm-audit-output.txt || true)
              DEP_FINDINGS=${DEP_FINDINGS:-1}
            fi

          elif [ "${{ inputs.language }}" = "go" ]; then
            echo "=== govulncheck ==="
            govulncheck ./... 2>&1 | tee govulncheck-output.txt
            GOV_EXIT=${PIPESTATUS[0]}
            if [ "$GOV_EXIT" -ne 0 ]; then
              DEP_FINDINGS=$(grep -c "Vulnerability" govulncheck-output.txt || true)
              DEP_FINDINGS=${DEP_FINDINGS:-1}
            fi
          fi

          echo "findings=${DEP_FINDINGS:-0}" >> "$GITHUB_OUTPUT"
          echo "::notice::Dependency audit found $DEP_FINDINGS issue(s)"

      - name: Trivy filesystem vulnerability scan
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: "fs"
          scan-ref: ${{ inputs.working_directory }}
          format: "json"
          output: "trivy-results.json"
          exit-code: "0"
          severity: "CRITICAL,HIGH,MEDIUM,LOW"

      - name: Aggregate security results
        id: result
        if: always()
        shell: bash
        run: |
          SAST="${{ steps.sast.outputs.findings }}"
          DEPS="${{ steps.deps.outputs.findings }}"
          SAST=${SAST:-0}
          DEPS=${DEPS:-0}

          TRIVY_FILE="trivy-results.json"
          CRITICAL=0; HIGH=0; MEDIUM=0; LOW=0
          if [ -f "$TRIVY_FILE" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$TRIVY_FILE" 2>/dev/null || true)
            CRITICAL=${CRITICAL:-0}
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$TRIVY_FILE" 2>/dev/null || true)
            HIGH=${HIGH:-0}
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$TRIVY_FILE" 2>/dev/null || true)
            MEDIUM=${MEDIUM:-0}
            LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$TRIVY_FILE" 2>/dev/null || true)
            LOW=${LOW:-0}
          fi

          TOTAL_FINDINGS=$((SAST + DEPS + CRITICAL + HIGH + MEDIUM + LOW))

          echo "sast_findings=$SAST" >> "$GITHUB_OUTPUT"
          echo "dep_findings=$DEPS" >> "$GITHUB_OUTPUT"
          echo "critical=${CRITICAL:-0}" >> "$GITHUB_OUTPUT"
          echo "high=${HIGH:-0}" >> "$GITHUB_OUTPUT"
          echo "medium=${MEDIUM:-0}" >> "$GITHUB_OUTPUT"
          echo "low=${LOW:-0}" >> "$GITHUB_OUTPUT"

          echo "=== Security Summary ==="
          echo "SAST findings:     $SAST"
          echo "Dependency issues: $DEPS"
          echo "Trivy Critical:    $CRITICAL"
          echo "Trivy High:        $HIGH"
          echo "Trivy Medium:      $MEDIUM"
          echo "Trivy Low:         $LOW"
          echo "Total findings:    $TOTAL_FINDINGS"

          echo "::notice title=ci_security::sast=$SAST|deps=$DEPS|critical=$CRITICAL|high=$HIGH|medium=$MEDIUM|low=$LOW"

          if [ "$TOTAL_FINDINGS" -gt 0 ]; then
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "::error::Security scan found $TOTAL_FINDINGS issue(s)"
          else
            echo "status=success" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ inputs.language }}
          path: |
            **/bandit-report.json
            **/gosec-report.json
            **/trivy-results.json
            **/pip-audit-output.txt
            **/npm-audit-output.txt
            **/govulncheck-output.txt
          retention-days: 30
          if-no-files-found: ignore

      - name: Fail if security findings
        if: steps.result.outputs.status == 'failure'
        run: |
          echo "Security scan found issues. See summary above."
          exit 1

      - name: Notify Slack on security failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        uses: mruthyunjaya-lakkappanavar/github-shared-workflows/actions/slack-notify@main
        with:
          status: failure
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          repo_name: ${{ github.repository }}
          run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          message: "Security scan found issues for ${{ inputs.language }}"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  #  JOB 4 ‚Äî CI Summary (runs after all jobs)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ci-status:
    name: CI Status
    if: always()
    needs: [lint, test, security]
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Post CI summary on PR
        if: |
          github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const icon = (s) => s === 'success' ? '‚úÖ' : s === 'failure' ? '‚ùå' : s === 'skipped' ? '‚è≠Ô∏è' : '‚è≥';

            const lintResult = '${{ needs.lint.result }}';
            const testResult = '${{ needs.test.result }}';
            const secResult  = '${{ needs.security.result }}';

            const lintErrors   = '${{ needs.lint.outputs.error_count }}' || '0';
            const testTotal    = '${{ needs.test.outputs.total }}'  || '0';
            const testPassed   = '${{ needs.test.outputs.passed }}' || '0';
            const testFailed   = '${{ needs.test.outputs.failed }}' || '0';
            const testCoverage = '${{ needs.test.outputs.coverage }}' || 'N/A';
            const sastFindings = '${{ needs.security.outputs.sast_findings }}' || '0';
            const depFindings  = '${{ needs.security.outputs.dep_findings }}'  || '0';
            const vulnCritical = '${{ needs.security.outputs.critical }}' || '0';
            const vulnHigh     = '${{ needs.security.outputs.high }}'     || '0';
            const vulnMedium   = '${{ needs.security.outputs.medium }}'   || '0';
            const vulnLow      = '${{ needs.security.outputs.low }}'      || '0';

            // Coverage threshold check (95%)
            const COVERAGE_THRESHOLD = ${{ inputs.coverage_threshold }};
            let covValue = parseFloat(testCoverage);
            let covIcon = 'üìä';
            let covDetail = testCoverage;
            if (!isNaN(covValue)) {
              covIcon = covValue >= COVERAGE_THRESHOLD ? '‚úÖ' : '‚ùå';
              covDetail = testCoverage + (covValue < COVERAGE_THRESHOLD ? ' (below ' + COVERAGE_THRESHOLD + '% threshold)' : '');
            }

            const overall = [lintResult, testResult, secResult].some(s => s === 'failure')
              || (!isNaN(covValue) && covValue < COVERAGE_THRESHOLD)
              ? '‚ùå Failed' : '‚úÖ Passed';

            const lines = [
              '## üìã CI Summary',
              '',
              '| Check | Status | Details |',
              '|-------|--------|---------|',
              '| **Lint** | ' + icon(lintResult) + ' | ' + (lintResult === 'success' ? 'All OK' : lintErrors + ' error(s)') + ' |',
              '| **Tests** | ' + icon(testResult) + ' | ' + testTotal + ' total, ' + testPassed + ' passed, ' + testFailed + ' failed |',
              '| **Coverage** | ' + covIcon + ' | ' + covDetail + ' |',
              '| **SAST** | ' + icon(secResult) + ' | ' + sastFindings + ' finding(s) |',
              '| **Dependencies** | ' + icon(secResult) + ' | ' + depFindings + ' issue(s) |',
              '| **Vulnerabilities** | ' + icon(secResult) + ' | ' + vulnCritical + ' critical, ' + vulnHigh + ' high, ' + vulnMedium + ' medium, ' + vulnLow + ' low |',
              '',
              '**Overall: ' + overall + '**',
              '',
              '[View Full Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            ];

            const body = lines.join('\n');
            const prNumber = context.payload.pull_request?.number;
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }

      - name: Check overall status
        shell: bash
        run: |
          echo "Lint:     ${{ needs.lint.result }}"
          echo "Test:     ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Coverage: ${{ needs.test.outputs.coverage }}"

          FAILED=false
          if [[ "${{ needs.lint.result }}" == "failure" || \
                "${{ needs.test.result }}" == "failure" || \
                "${{ needs.security.result }}" == "failure" ]]; then
            FAILED=true
          fi

          # Check coverage threshold (95%)
          COV="${{ needs.test.outputs.coverage }}"
          COV_NUM=$(echo "$COV" | grep -oE '[0-9]+\.?[0-9]*' | head -1 || true)
          if [ -n "$COV_NUM" ]; then
            THRESHOLD=${{ inputs.coverage_threshold }}
            if (( $(echo "$COV_NUM < $THRESHOLD" | bc -l) )); then
              echo "::error::Code coverage ${COV} is below the ${THRESHOLD}% threshold"
              FAILED=true
            fi
          fi

          if [ "$FAILED" = "true" ]; then
            echo "CI failed"
            exit 1
          fi
          echo "All CI checks passed"

      - name: Notify Slack on overall success
        if: success() && env.SLACK_WEBHOOK_URL != '' && github.ref == 'refs/heads/main'
        uses: mruthyunjaya-lakkappanavar/github-shared-workflows/actions/slack-notify@main
        with:
          status: success
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          repo_name: ${{ github.repository }}
          run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
